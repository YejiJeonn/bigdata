"""ê¸°ë§í”„ë¡œì íŠ¸1.ipynb
Step_1. ë¶„ì•¼ë³„ ì£¼ì‹ ì¢…ëª© í‰ê· ì£¼ê°€ ë° í‰ê·  ë“±ë½ìœ¨ ì‹œê°í™”

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1TxJfriaxaTuygA9o4yHzZPIgwyNvpCsZ
"""
# -- 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜ --
# !apt-get update
# !apt install -y chromium-chromedriver
# !pip install selenium pandas matplotlib bs4
# !apt-get install -y fonts-nanum
# !pip install webdriver-manager
# !apt-get update
# !apt-get install -y wget unzip
## Chrome ì„¤ì¹˜
# !wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
# !apt-get -y install ./google-chrome-stable_current_amd64.deb
## ChromeDriver ì„¤ì¹˜ (Chrome ë²„ì „ì— ë§ì¶° ìë™ ë‹¤ìš´ë¡œë“œ)
# !CHROME_VERSION=$(google-chrome --version | sed 's/Google Chrome //')
# !wget -O chromedriver.zip https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip
# !unzip chromedriver.zip
# !mv chromedriver-linux64/chromedriver /usr/bin/chromedriver
# !chmod +x /usr/bin/chromedriver
# !pip install squarify

# -- 2. í•œêµ­ì–´ê¸€ê¼´ ì ìš© --
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import matplotlib as mpl
import os

font_dirs = ['/usr/share/fonts/truetype/nanum']
font_files = fm.findSystemFonts(fontpaths=font_dirs)

for fpath in font_files:
    fm.fontManager.addfont(fpath)

fm._load_fontmanager(try_read_cache=False)

plt.rc('font', family='NanumGothic')
mpl.rcParams['axes.unicode_minus'] = False

print([f.name for f in fm.fontManager.ttflist if 'Nanum' in f.name])

# -- 3. í•œê²½ ì£¼ì‹ ë°ì´í„° í˜ì´ì§€ í¬ë¡¤ë§ --
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager # Import ChromeDriverManager
from bs4 import BeautifulSoup
import pandas as pd
import time

chrome_options = Options()
chrome_options.add_argument("--headless")
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")
chrome_options.add_argument("--disable-gpu")
chrome_options.add_argument("--window-size=1920,1080")
chrome_options.binary_location = '/usr/bin/google-chrome-stable'

service = Service(ChromeDriverManager().install())
driver = webdriver.Chrome(service=service, options=chrome_options)
driver.get("https://datacenter.hankyung.com/equities-all")

html = driver.page_source
driver.quit()

soup = BeautifulSoup(html, "lxml")

groups = soup.select("div.equities-group")
data = []

for group in groups:
    category = group.select_one(".group-tit .ellip").get_text(strip=True)
    for li in group.select("li"):
        name_tag = li.select_one(".stock-title a")
        price_tag = li.select_one(".price")
        rate_tag = li.select_one(".rate")
        if name_tag and price_tag and rate_tag:
            name = name_tag.get_text(strip=True)
            price = price_tag.get_text(strip=True).replace(",", "")
            rate = rate_tag.get_text(strip=True).replace("%", "").replace("+", "")
            price = pd.to_numeric(price, errors="coerce")
            rate = pd.to_numeric(rate, errors="coerce")
            data.append({"ë¶„ì•¼": category, "ì¢…ëª©": name, "í˜„ì¬ê°€": price, "ë“±ë½ë¥ ": rate})

df = pd.DataFrame(data)
print(df.head())
print(f"ì´ {len(df)}ê°œ ì¢…ëª© ìˆ˜ì§‘ ì™„ë£Œ")
print("--------------------------")
print(df['ë¶„ì•¼'].value_counts())

## í¬ë¡¤ë§ ë°ì´í„° csvíŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ë‚´ì—­ í™•ì¸ ê°€ëŠ¥
df.to_csv('hankyung_stocks.csv', index=False, encoding='utf-8-sig')

# -- 4. ë§‰ëŒ€ ì°¨íŠ¸ ê·¸ë˜í”„ --
if not df.empty and "í˜„ì¬ê°€" in df.columns:
  df = df.dropna(subset=["í˜„ì¬ê°€", "ë“±ë½ë¥ "])
  grouped = df.groupby("ë¶„ì•¼")[["í˜„ì¬ê°€", "ë“±ë½ë¥ "]].mean().reset_index()

  ## HTMl íŒŒì¼ë¡œ ì €ì¥
  df.to_html("ì „ì²´_ì¢…ëª©_ë°ì´í„°.html", index=False, escape=False)
  grouped.to_html("ë¶„ì•¼ë³„_í‰ê· _ë°ì´í„°.html", index=False, escape=False)
  print("ğŸ“ HTML ì €ì¥ ì™„ë£Œ: ì „ì²´_ì¢…ëª©_ë°ì´í„°.html / ë¶„ì•¼ë³„_í‰ê· _ë°ì´í„°.html")


  ## í‰ê·  ì£¼ê°€ ê·¸ë˜í”„
  plt.figure(figsize=(12,6))
  plt.bar(grouped["ë¶„ì•¼"], grouped["í˜„ì¬ê°€"], color="skyblue")
  plt.xticks(rotation=90)
  plt.title("ë¶„ì•¼ë³„ í‰ê·  ì£¼ê°€")
  plt.xlabel("ë¶„ì•¼")
  plt.ylabel("í‰ê·  í˜„ì¬ê°€")
  plt.tight_layout()
  plt.show()

  ## í‰ê·  ë“±ë½ë¥  ê·¸ë˜í”„
  plt.figure(figsize=(12,6))
  plt.bar(grouped["ë¶„ì•¼"], grouped["ë“±ë½ë¥ "], color="orange")
  plt.xticks(rotation=90)
  plt.title("ë¶„ì•¼ë³„ í‰ê·  ë“±ë½ë¥ (%)")
  plt.xlabel("ë¶„ì•¼")
  plt.ylabel("í‰ê·  ë“±ë½ë¥ (%)")
  plt.tight_layout()
  plt.show()
else:
  print("âŒ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. HTML êµ¬ì¡° ë³€ê²½ ë˜ëŠ” ë¡œë“œ ì‹¤íŒ¨.")

# -- 5. ë ˆì´ë” ì°¨íŠ¸  --
import numpy as np

labels = grouped["ë¶„ì•¼"].tolist()
num_vars = len(labels)

angles = np.linspace(0, 2 * np.pi, num_vars, endpoint=False).tolist()
angles += angles[:1]

values_price = grouped["í˜„ì¬ê°€"].tolist()
values_price += values_price[:1]
values_return = grouped["ë“±ë½ë¥ "].tolist()
values_return += values_return[:1]

fig, axes = plt.subplots(1, 2, figsize=(14, 6), subplot_kw={"projection": "polar"})

## í‰ê·  ì£¼ê°€
axes[0].plot(angles, values_price, linewidth=2)
axes[0].fill(angles, values_price, alpha=0.25)
axes[0].set_title("ë¶„ì•¼ë³„ í‰ê·  ì£¼ê°€ ë ˆì´ë” ì°¨íŠ¸", pad=25)   # â† ê°„ê²© ë„“í˜
axes[0].set_xticks(angles[:-1])
axes[0].set_xticklabels(labels, fontsize=7)

## í‰ê·  ë“±ë½ë¥ 
axes[1].plot(angles, values_return, color="orange", linewidth=2)
axes[1].fill(angles, values_return, alpha=0.25, color="orange")
axes[1].set_title("ë¶„ì•¼ë³„ í‰ê·  ë“±ë½ë¥  ë ˆì´ë” ì°¨íŠ¸", pad=25)  # â† ê°„ê²© ë„“í˜
axes[1].set_xticks(angles[:-1])
axes[1].set_xticklabels(labels, fontsize=7)

plt.tight_layout()
plt.subplots_adjust(top=0.85)  # â† ì „ì²´ ì—¬ë°± ì¶”ê°€
plt.show()

# 6. íŠ¸ë¦¬ë§µ (í‰ê·  ì£¼ê°€ / í‰ê·  ë“±ë½ë¥ )
import squarify
import seaborn as sns
import numpy as np
import matplotlib.pyplot as plt

fig, axes = plt.subplots(1, 2, figsize=(16, 7))

## í‰ê·  ì£¼ê°€
squarify.plot(
    sizes=grouped["í˜„ì¬ê°€"],
    label=grouped["ë¶„ì•¼"],
    color=sns.color_palette("Blues", len(grouped)),
    ax=axes[0],
    alpha=0.8
)
axes[0].set_title("ë¶„ì•¼ë³„ í‰ê·  ì£¼ê°€ Treemap", pad=15)
axes[0].axis('off')

## í‰ê·  ë“±ë½ë¥ 
squarify.plot(
    sizes=np.abs(grouped["ë“±ë½ë¥ "]),   # ì ˆëŒ€ê°’ ì‚¬ìš©
    label=grouped["ë¶„ì•¼"],
    color=sns.color_palette("Oranges", len(grouped)),
    ax=axes[1],
    alpha=0.8
)
axes[1].set_title("ë¶„ì•¼ë³„ í‰ê·  ë“±ë½ë¥  Treemap", pad=15)
axes[1].axis('off')

plt.tight_layout()
plt.show()

##  7. ë²„ë¸” ì°¨íŠ¸
import numpy as np
import matplotlib.pyplot as plt

fig, axes = plt.subplots(1, 2, figsize=(16, 7))


## íˆ¬ëª…ë„(ì•ŒíŒŒ) ìŠ¤ì¼€ì¼ë§ í•¨ìˆ˜
def normalize_alpha(values):
    v = (values - values.min()) / (values.max() - values.min() + 1e-6)
    return 0.1 + v * 0.9    # â˜… ë²”ìœ„ 0.1 ~ 1.0 (ì§„í•˜ê¸° ì°¨ì´ ê°•ì¡°)


## í‰ê·  ì£¼ê°€ ê¸°ë°˜ ë²„ë¸” ì°¨íŠ¸
bubble_size_price = grouped["í˜„ì¬ê°€"] / 10

alpha_price = normalize_alpha(grouped["í˜„ì¬ê°€"])   # ì§„í•˜ê¸° = í‰ê·  ì£¼ê°€ ê¸°ì¤€

axes[0].scatter(
    grouped["ë“±ë½ë¥ "],
    grouped["í˜„ì¬ê°€"],
    s=bubble_size_price,
    alpha=alpha_price,
    color="skyblue",
    edgecolors="black"
)

for i, txt in enumerate(grouped["ë¶„ì•¼"]):
    axes[0].annotate(txt, (grouped["ë“±ë½ë¥ "][i], grouped["í˜„ì¬ê°€"][i]))

axes[0].set_title("í‰ê·  ì£¼ê°€ ë²„ë¸”ì°¨íŠ¸ã…‹")
axes[0].set_xlabel("í‰ê·  ë“±ë½ë¥ ")
axes[0].set_ylabel("í‰ê·  í˜„ì¬ê°€")
axes[0].grid(True)


## í‰ê·  ë“±ë½ë¥  ê¸°ë°˜ ë²„ë¸” ì°¨íŠ¸
bubble_size_return = np.abs(grouped["ë“±ë½ë¥ "]) * 150  # ì•½ê°„ ì¶•ì†Œ
alpha_return = normalize_alpha(np.abs(grouped["ë“±ë½ë¥ "]))

axes[1].scatter(
    grouped["ë“±ë½ë¥ "],
    grouped["í˜„ì¬ê°€"],
    s=bubble_size_return,
    alpha=alpha_return,
    color="orange",
    edgecolors="black"
)

for i, txt in enumerate(grouped["ë¶„ì•¼"]):
    axes[1].annotate(txt, (grouped["ë“±ë½ë¥ "][i], grouped["í˜„ì¬ê°€"][i]))

axes[1].set_title("í‰ê·  ë“±ë½ë¥  ë²„ë¸”ì°¨íŠ¸")
axes[1].set_xlabel("í‰ê·  ë“±ë½ë¥ ")
axes[1].set_ylabel("í‰ê·  í˜„ì¬ê°€")
axes[1].grid(True)


plt.tight_layout()
plt.show()