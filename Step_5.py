# -*- coding: utf-8 -*-
"""ê¸°ë§ í”„ë¡œì íŠ¸_5.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1K1b-rgABlki5qjsfL7q_QhIQxFwoSOVq
"""

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ìµœì´ˆ 1íšŒë§Œ ì‹¤í–‰)
!pip install finance-datareader
!apt-get update -qq
!apt-get install -y fonts-nanum

import pandas as pd
import matplotlib.pyplot as plt
import FinanceDataReader as fdr
import matplotlib.font_manager as fm
import matplotlib as mpl

# --- ì„¤ì¹˜ëœ ë‚˜ëˆ” í°íŠ¸ ì ìš© ---
font_dirs = ['/usr/share/fonts/truetype/nanum']
font_files = fm.findSystemFonts(fontpaths=font_dirs)

for fpath in font_files:
    fm.fontManager.addfont(fpath)

plt.rc('font', family='NanumGothic')
mpl.rcParams['axes.unicode_minus'] = False

# ì£¼ì‹ ë¹„êµë¥¼ ìœ„í•œ íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©

# ë¹„êµí•  ê¸°ê°„ ì„¤ì •
start_date = "2010-01-01"
end_date   = "2025-01-01"

# KOSPI, KOSDAQ ì§€ìˆ˜ ë°ì´í„°ë¥¼ FinanceDataReaderì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
# ì§€ìˆ˜ëª…ì€ 'KOSPI'ì™€ 'KOSDAQ'ìœ¼ë¡œ ì§€ì •
kospi_df  = fdr.DataReader('KOSPI',  start_date, end_date).reset_index()
kosdaq_df = fdr.DataReader('KOSDAQ', start_date, end_date).reset_index()

# ë‚ ì§œ ì»¬ëŸ¼ ì´ë¦„ì„ ë§ì¶°ì£¼ê¸° (FinanceDataReaderëŠ” 'Date' ëŒ€ì‹  'index'ë¥¼ ë°˜í™˜í•¨)
kospi_df.rename(columns={'index':'Date'}, inplace=True)
kosdaq_df.rename(columns={'index':'Date'}, inplace=True)

# ì •ê·œí™”(ì²« ë‹¬ = 100)
kospi_df['Norm']  = kospi_df['Close'] / kospi_df['Close'].iloc[0] * 100
kosdaq_df['Norm'] = kosdaq_df['Close'] / kosdaq_df['Close'].iloc[0] * 100

# ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
plt.figure(figsize=(10,5))
plt.plot(kospi_df['Date'],  kospi_df['Norm'],  label="KOSPI (ì •ê·œí™”)")
plt.plot(kosdaq_df['Date'], kosdaq_df['Norm'], label="KOSDAQ (ì •ê·œí™”)")
plt.title("KOSPI vs KOSDAQ ì •ê·œí™” ì¶”ì„¸ (2010~)")
plt.xlabel("ë‚ ì§œ")
plt.ylabel("ì§€ìˆ˜ (ì²« ë‹¬ = 100)")
plt.legend()
plt.grid(True)
plt.show()

# --- ì›” ë‹¨ìœ„ë¡œ ë³€í™˜ ---
kospi_df['YearMonth'] = kospi_df['Date'].dt.to_period('M')
kosdaq_df['YearMonth']   = kosdaq_df['Date'].dt.to_period('M')

# ì›”ë³„ ìˆ˜ìµë¥  ê³„ì‚°
kospi_return = kospi_df.groupby('YearMonth')['Close'].last().pct_change()
kosdaq_return   = kosdaq_df.groupby('YearMonth')['Close'].last().pct_change()

# ë°ì´í„° í•©ì¹˜ê¸°
ret_df = pd.concat([kospi_return, kosdaq_return], axis=1)
ret_df.columns = ['KOSPI_Return', 'KOSDAQ_Return']

# ê²°ì¸¡ì¹˜ ì œê±°
ret_df = ret_df.dropna()

# ìƒê´€ê³„ìˆ˜ ê³„ì‚°
corr_value = ret_df['KOSPI_Return'].corr(ret_df['KOSDAQ_Return'])

print("KOSPI â†” KOSDAQ ìƒê´€ê³„ìˆ˜:", corr_value)

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.preprocessing import MinMaxScaler
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense

# ------------------------------------------------------
# 1) ì‹œí€€ìŠ¤ ë°ì´í„° ìƒì„± í•¨ìˆ˜
# ------------------------------------------------------
def create_sequences(data, window=60):
    X, y = [], []
    for i in range(window, len(data)):
        X.append(data[i - window:i])
        y.append(data[i])
    return np.array(X), np.array(y)

# ë¯¸ë˜ ì˜ˆì¸¡ í•¨ìˆ˜
def predict_future(model, last_sequence, future_steps=300):
    preds = []
    current_seq = last_sequence.copy()  # shape (60,1)

    for _ in range(future_steps):

        pred = model.predict(current_seq.reshape(1,60,1), verbose=0)
        pred_value = pred[0][0]   # ğŸ”¥ 1x1 â†’ scalar ì¶”ì¶œ

        preds.append(pred_value)

        # ğŸ”¥ shape ìœ ì§€: (59,1) + (1,1) â†’ (60,1)
        current_seq = np.vstack([current_seq[1:], [[pred_value]]])

    return np.array(preds)


# ------------------------------------------------------
# 2) LSTM ì˜ˆì¸¡ ìˆ˜í–‰ í•¨ìˆ˜
# ------------------------------------------------------
def run_lstm_prediction(df, label="KOSPI"):
    print(f"\n===== {label} LSTM ì˜ˆì¸¡ ì‹œì‘ =====")

    # ê¸°ì¤€ì¼
    train_end = pd.to_datetime("2021-01-01")
    test_end  = pd.to_datetime("2023-01-01")

    # ë‚ ì§œ ì •ë ¬
    df = df.sort_values("Date").copy()
    df["Date"] = pd.to_datetime(df["Date"])

    # 1. Close ë°ì´í„° ìŠ¤ì¼€ì¼ë§
    close = df["Close"].values.reshape(-1, 1)
    scaler = MinMaxScaler()
    scaled_all = scaler.fit_transform(close)

    # 2. Boolean Mask ìƒì„± (ê°€ì¥ ì¤‘ìš”!)
    train_mask  = df["Date"] <= train_end
    test_mask   = (df["Date"] > train_end) & (df["Date"] <= test_end)
    future_mask = df["Date"] > test_end

    # 3. ë°ì´í„° ë¶„ë¦¬
    scaled_train  = scaled_all[train_mask]
    scaled_test   = scaled_all[test_mask]
    scaled_future = scaled_all[future_mask]

    # ì‹œí€€ìŠ¤ ìƒì„±
    window = 60
    X_train, y_train = create_sequences(scaled_train, window)
    X_test,  y_test  = create_sequences(scaled_test, window)

    # 4. ëª¨ë¸ êµ¬ì„±
    model = Sequential([
        LSTM(64, return_sequences=True, input_shape=(window, 1)),
        LSTM(32),
        Dense(1)
    ])

    model.compile(optimizer='adam', loss='mse')
    model.fit(X_train, y_train, epochs=15, batch_size=32, validation_split=0.1, verbose=1)

    # 5. í…ŒìŠ¤íŠ¸ ì˜ˆì¸¡
    y_pred_test = model.predict(X_test)
    y_pred_test_inv = scaler.inverse_transform(y_pred_test)
    y_test_inv = scaler.inverse_transform(y_test)

    # í…ŒìŠ¤íŠ¸ êµ¬ê°„ ë‚ ì§œ
    test_dates_full = df.loc[test_mask, "Date"].values
    test_dates = test_dates_full[window:]

    # 6. ë¯¸ë˜ ì˜ˆì¸¡
    if len(scaled_test) >= window and len(scaled_future) > 0:
        last_seq = scaled_test[-window:]
        future_steps = len(scaled_future)

        future_pred_scaled = predict_future(model, last_seq, future_steps)
        future_pred = scaler.inverse_transform(future_pred_scaled.reshape(-1,1))
        future_true = scaler.inverse_transform(scaled_future)

        future_dates = df.loc[future_mask, "Date"].values[:future_steps]
    else:
        future_pred = None

    # 7. ê·¸ë˜í”„ 1 â€” í…ŒìŠ¤íŠ¸ ê¸°ê°„
    plt.figure(figsize=(12,4))
    plt.plot(test_dates, y_test_inv, label="ì‹¤ì œ(í…ŒìŠ¤íŠ¸)")
    plt.plot(test_dates, y_pred_test_inv, linestyle="--", label="ì˜ˆì¸¡(í…ŒìŠ¤íŠ¸)")
    plt.title(f"{label} í…ŒìŠ¤íŠ¸ êµ¬ê°„ LSTM ì˜ˆì¸¡ (2021~2023)")
    plt.grid(True)
    plt.legend()
    plt.show()

    # 8. ê·¸ë˜í”„ 2 â€” ë¯¸ë˜ ì˜ˆì¸¡
    if future_pred is not None:
        plt.figure(figsize=(12,4))
        plt.plot(future_dates, future_true, label="ì‹¤ì œ(2023~)")
        plt.plot(future_dates, future_pred, linestyle="--", label="ì˜ˆì¸¡(2023~)")
        plt.title(f"{label} ë¯¸ë˜ LSTM ì˜ˆì¸¡ (2023~2025)")
        plt.grid(True)
        plt.legend()
        plt.show()

    return model, y_pred_test_inv, y_test_inv

# ------------------------------------------------------
# 4) KOSPI & KOSDAQ LSTM ì˜ˆì¸¡ ì‹¤í–‰
# ------------------------------------------------------
kospi_model, kospi_pred, kospi_true = run_lstm_prediction(kospi_df,  label="KOSPI")
kosdaq_model, kosdaq_pred, kosdaq_true = run_lstm_prediction(kosdaq_df, label="KOSDAQ")